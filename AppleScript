
-- bit.ly/ä¸‹è¼‰_é±«é°°iCloudDriveä½¿ç”¨è€…é®¦æ­¥ 
--æ’é™¤={ç·©å­˜,å…¬ç”¨,æ¡Œé¢} 

------------------------------âˆ iCloudDriveUserSync âˆ----------------------------------ON.  
global iCloudMode, iCloudRsyncMode, OpenScript, iCloud_To_User, rsyncPath, rsyncParameter, UserName, SyncSource, SyncDest, TerminalNotifier, isDone, itemPath, itemProgress, errmsg, errnbr
global firstRun, RT_Seconds, RT_Option, RT_Option_HDW, errmsg, errnbr
global iCloudRsyncMode, firstRun, RT_Seconds, rsyncPath, rsyncParameter, SyncSource, SyncDest, errmsg, errnbr
global iCloudRsyncMode, firstRun, RT_Seconds, RT_Option, RT_Option_HDW, errmsg, errnbr
global CloudRsyncMode, firstRun, RT_Seconds, rsyncPath, rsyncParameter, SyncSource, SyncDest, RT_Option, RT_Option_HDW, errmsg, errnbr
global iCloud_To_User, rsyncPath, rsyncParameter, UserName, SyncSource, SyncDest, TerminalNotifier, isDone, itemPath, itemProgress, errmsg, errnbr
global OpenScript, OpenAppScript, TerminalNotifier, errmsg, errnbr

on run
	try
		tell application "Finder"
			set {button returned:iCloudMode} to Â¬
				display dialog {"è«‹é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡ iCloudDrive é®¦æ­¥é¸é … å”·ğŸ’‹"} buttons Â¬
					{"ä½¿ç”¨è€…é®¦æ­¥è‡³iCloudDrive", "iCloudDriveé®¦æ­¥è‡³ä½¿ç”¨è€…", "é–‹å•Ÿè…³æœ¬"} with title Â¬
					{"iCloudDriveé®¦æ­¥"}
			if iCloudMode is "é–‹å•Ÿè…³æœ¬" then run script OpenScript
			if iCloudMode is "iCloudDriveé®¦æ­¥è‡³ä½¿ç”¨è€…" then run script iCloud_To_User
			if iCloudMode is "ä½¿ç”¨è€…é®¦æ­¥è‡³iCloudDrive" then
				set {button returned:iCloudRsyncMode} to Â¬
					display dialog {"è«‹é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡ä½¿ç”¨è€…é®¦æ­¥è‡³iCloudDriveé¸é … å”·ğŸ’‹"} buttons Â¬
						{"ä½¿ç”¨è€…é®¦æ­¥è‡³iCloudDriveé±“æ¬¡é®¦æ­¥", "ä½¿ç”¨è€…é®¦æ­¥è‡³iCloudDriveå¯¦é°£é®¦æ­¥"} with title Â¬
						{"iCloudDriveé®¦æ­¥"}
				
				if iCloudRsyncMode is "ä½¿ç”¨è€…é®¦æ­¥è‡³iCloudDriveé±“æ¬¡é®¦æ­¥" then
					
					set rsyncPath to POSIX path of (path to me as text) & ("Contents/MacOS/rsync")
					set rsyncPath to quoted form of rsyncPath
					
					set rsyncParameter to (" -ESWPaudvxh80AX --delete --stats --exclude={.*,Library,Public,Desktop} ")
					
					set UserName to do shell script "whoami"
					set UserName to quoted form of UserName
					
					set SyncSource to ("~/")
					set SyncDest to ("~/Library/'Mobile Documents'/com~apple~CloudDocs/" & UserName & "/")
					
					set TerminalNotifier to POSIX path of (path to me as text) Â¬
						& {"Contents/MacOS/terminal-notifier"}
					set TerminalNotifier to quoted form of TerminalNotifier
					do shell script (TerminalNotifier & " -title iCloudDriveé®¦æ­¥ä¸­å”·ğŸ’‹")
					
					do shell script {rsyncPath & rsyncParameter & SyncSource & " " & SyncDest}
					delay 1
					set isDone to false
					set itemPath to ("rsync ")
					set itemProgress to "ps ax | grep -v grep | grep " & itemPath
					repeat while isDone is false
						try
							do shell script itemProgress
							if the result contains itemPath then
								delay 1
							else
								set isDone to true
							end if
						on error
							set isDone to true
						end try
					end repeat
					if isDone is true then
						do shell script (TerminalNotifier & " -title iCloudDriveé®¦æ­¥é¯‡æˆé°³å”·ğŸ’‹")
						do shell script ("open " & SyncDest)
						continue quit
					end if
				end if
				if iCloudRsyncMode is "ä½¿ç”¨è€…é®¦æ­¥è‡³iCloudDriveå¯¦é°£é®¦æ­¥" then
					set firstRun to true
					set RT_Seconds to ("")
					set {button returned:RT_Option} to Â¬
						display dialog {" 
è«‹é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡ é®¦æ­¥é–“éš”é±“ä½ å”·ğŸ’‹"} buttons Â¬
							{"ç§’", "é­µ", "é°£ æ—¥ é€±"} with title Â¬
							{"iCloudDriveé®¦æ­¥"}
					
					if RT_Option is "ç§’" then return RT_Seconds
					if RT_Option is "é­µ" then return {RT_Seconds * minutes}
					
					if RT_Option is "é°£ æ—¥ é€±" then
						set {button returned:RT_Option_HDW} to Â¬
							display dialog {" 
è«‹é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡ é®¦æ­¥é–“éš”é±“ä½ å”·ğŸ’‹"} buttons Â¬
								{"é°£", "æ—¥", "é€±"} with title Â¬
								{"iCloudDriveé®¦æ­¥"}
						
						if RT_Option_HDW is "é°£" then return {RT_Seconds * hours}
						if RT_Option_HDW is "æ—¥" then return {RT_Seconds * days}
						if RT_Option_HDW is "é€±" then return {RT_Seconds * weeks}
						
					end if
				end if
			end if
		end tell
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
		continue quit
	end try
end run

on idle
	try
		if iCloudRsyncMode is "ä½¿ç”¨è€…é®¦æ­¥è‡³iCloudDriveå¯¦é°£é®¦æ­¥" then
			if firstRun then
				tell application "Finder" to display dialog {"è«‹æ²å¥³é°°é°é­é–“éš”æ•¸å­—ï¼Œå€˜é°™é°¡ç©ºé±‚ä»¥æœ€å°é–“éš”å€¼é®¦æ­¥å”·ğŸ’‹"} default answer ("") with title Â¬
					{"iCloudDriveé®¦æ­¥"}
				set RT_Seconds to ((text returned of the result) as integer)
				if RT_Seconds is "" then return continue quit
				set firstRun to false
			else
				try
					do shell script {rsyncPath & rsyncParameter & SyncSource & " " & SyncDest}
				end try
			end if
			if firstRun is "" then return seconds
			if RT_Option is "ç§’" then return RT_Seconds
			if RT_Option is "é­µ" then return {RT_Seconds * minutes}
			if RT_Option_HDW is "é°£" then return {RT_Seconds * hours}
			if RT_Option_HDW is "æ—¥" then return {RT_Seconds * days}
			if RT_Option_HDW is "é€±" then return {RT_Seconds * weeks}
		end if
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
	end try
end idle
------------------------------âˆ iCloudDriveé®¦æ­¥è‡³ä½¿ç”¨è€…  âˆ----------------------------------ON.  
script iCloud_To_User
	try
		tell application "Finder"
			set rsyncPath to POSIX path of (path to me as text) & ("Contents/MacOS/rsync")
			set rsyncPath to quoted form of rsyncPath
			
			set rsyncParameter to (" -ESWPaudvxh80AX --delete --stats --exclude={.*,Library,Public,Desktop} ")
			
			set UserName to do shell script "whoami"
			set UserName to quoted form of UserName
			
			set SyncSource to ("~/Library/'Mobile Documents'/com~apple~CloudDocs/" & UserName & "/")
			set SyncDest to ("~/")
			
			set TerminalNotifier to POSIX path of (path to me as text) Â¬
				& {"Contents/MacOS/terminal-notifier"}
			set TerminalNotifier to quoted form of TerminalNotifier
			do shell script (TerminalNotifier & " -title iCloudDriveé®¦æ­¥ä¸­å”·ğŸ’‹")
			
			{do shell script rsyncPath & rsyncParameter & SyncSource & " " & SyncDest}
			delay 1
			set isDone to false
			set itemPath to ("rsync ")
			set itemProgress to "ps ax | grep -v grep | grep " & itemPath
			repeat while isDone is false
				try
					do shell script itemProgress
					if the result contains itemPath then
						delay 1
					else
						set isDone to true
					end if
				on error
					set isDone to true
				end try
			end repeat
			if isDone is true then
				do shell script (TerminalNotifier & " -title iCloudDriveé®¦æ­¥é¯‡æˆé°³å”·ğŸ’‹")
				do shell script ("open " & SyncDest)
				continue quit
			end if
		end tell
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
		continue quit
	end try
end script
------------------------ é–‹å•Ÿè…³æœ¬ ------------------------ON. 
script OpenScript
	try
		tell application "Finder"
			set OpenAppScript to POSIX path of (path to me as text) & ("Contents/Resources/Scripts/main.scpt")
			set OpenAppScript to quoted form of OpenAppScript
			do shell script ("open " & OpenAppScript)
			set TerminalNotifier to POSIX path of (path to me as text) & ("Contents/MacOS/terminal-notifier")
			set TerminalNotifier to quoted form of TerminalNotifier
			do shell script (TerminalNotifier & " -title iCloudDriveè…³æœ¬å·²é–‹å•Ÿé°³å”·ğŸ’‹")
		end tell
		continue quit
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
		continue quit
	end try
end script
------------------------------âˆ iCloudDriveUserSync âˆ---------------------------------END.


-- 

