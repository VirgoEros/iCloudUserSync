
-- bit.ly/下載_鱫鰰iCloudDrive使用者鮦步 
--排除={緩存,公用,桌面} 

------------------------------∞ 鱫鰰iCloudDrive使用者鮦步 ∞----------------------------------ON.  
global iCloudMode, OpenScript, iCloud_To_User, iCloudRsyncMode, rsyncPath, rsyncParameter, UserName, SyncSource, SyncDest, TerminalNotifier, isDone, itemPath, itemProgress, errmsg, errnbr
global OpenScript, OpenAppScript, TerminalNotifier, errmsg, errnbr

on run
	try
		tell application "Finder"
			set {button returned:iCloudMode} to ¬
				display dialog {"請鰛鰇鱮美鱺沝療癒鯀女鰰選擇 iCloudDrive 鮦步選項 唷💋"} buttons ¬
					{"鱂沝女鰰mac裏的文件鮦步至iCloudDrive", "開啟腳本"} with title ¬
					{"鱫鰰iCloudDrive使用者鮦步"}
			if iCloudMode is "開啟腳本" then run script OpenScript
			if iCloudMode is "鱂沝女鰰mac裏的文件鮦步至iCloudDrive" then
				set rsyncPath to POSIX path of (path to me as text) & ("Contents/MacOS/rsync")
				set rsyncPath to quoted form of rsyncPath
				
				set rsyncParameter to (" -ESWPaudvxh80AX --delete --stats --exclude={.*,Library,Public,Desktop} ")
				
				set UserName to do shell script "whoami"
				set UserName to quoted form of UserName
				
				set SyncSource to ("~/")
				set SyncDest to ("~/Library/'Mobile Documents'/com~apple~CloudDocs/" & UserName & "/")
				
				set TerminalNotifier to POSIX path of (path to me as text) ¬
					& {"Contents/MacOS/terminal-notifier"}
				set TerminalNotifier to quoted form of TerminalNotifier
				do shell script (TerminalNotifier & " -title iCloudDrive鮦步中唷💋")
				
				do shell script {rsyncPath & rsyncParameter & SyncSource & " " & SyncDest}
				delay 1
				set isDone to false
				set itemPath to ("rsync ")
				set itemProgress to "ps ax | grep -v grep | grep " & itemPath
				repeat while isDone is false
					try
						do shell script itemProgress
						if the result contains itemPath then
							delay 1
						else
							set isDone to true
						end if
					on error
						set isDone to true
					end try
				end repeat
				if isDone is true then
					do shell script (TerminalNotifier & " -title iCloudDrive鮦步鯇成鰳唷💋")
					do shell script ("open " & SyncDest)
					continue quit
				end if
			end if
		end tell
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
		continue quit
	end try
end run
------------------------ 開啟腳本 ------------------------ON. 
script OpenScript
	try
		tell application "Finder"
			set OpenAppScript to POSIX path of (path to me as text) & ("Contents/Resources/Scripts/main.scpt")
			set OpenAppScript to quoted form of OpenAppScript
			do shell script ("open " & OpenAppScript)
			set TerminalNotifier to POSIX path of (path to me as text) & ("Contents/MacOS/terminal-notifier")
			set TerminalNotifier to quoted form of TerminalNotifier
			do shell script (TerminalNotifier & " -title iCloudDrive腳本已開啟鰳唷💋")
		end tell
		continue quit
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
		continue quit
	end try
end script
------------------------------∞ 鱫鰰iCloudDrive使用者鮦步 ∞---------------------------------END.


-- 

